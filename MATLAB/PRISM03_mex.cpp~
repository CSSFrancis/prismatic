#include <vector>
#include "fftw3.h"
#include "mex.h"

#define _probeDefocusArray 0
#define _probeSemiangleArray 1
#define _probeXtiltArray 2
#define _probeYtiltArray 3
#define _qxaReduce 4
#define _qyaReduce 5
#define _xp 6
#define _yp 7
#define _imageSize 8
#define _imageSizeReduce 9
#define _scale 10
#define _interpolationFactor 11
#define _pixelSize 12
#define _lambda 13

void mexFunction(int nlhs, mxArray *plhs[],
                 int nrhs, const mxArray *prhs[]){
    
    double *probeDefocusArray = mxGetPr(prhs[_probeDefocusArray]);
    double *probeSemiangleArray = mxGetPr(prhs[_probeSemiangleArray]);
    double *probeXtiltArray = mxGetPr(prhs[_probeXtiltArray]);
    double *probeYtiltArray = mxGetPr(prhs[_probeYtiltArray]);
    double *qxaReduce = mxGetPr(prhs[_qxaReduce]);
    double *qyaReduce = mxGetPr(prhs[_qyaReduce]);
    double *xp = mxGetPr(prhs[_xp]);
    double *yp = mxGetPr(prhs[_yp]);
    double *imageSize = mxGetPr(prhs[_imageSize]);
    double *imageSizeReduce = mxGetPr(prhs[_imageSizeReduce]);
    double scale = mxGetScalar(prhs[_scale]);
    double interpolationFactor = mxGetScalar(prhs[_interpolationFactor]);
    double pixelSize = mxGetScalar(prhs[_pixelSize]);
    double lambda = mxGetScalar(prhs[_lambda]);
    
    
    mexPrintf("hey there\n");
//     plhs[0] = mxDuplicateArray(prhs[0]);
    
    size_t mrows = mxGetM(prhs[0]);
    size_t ncols = mxGetN(prhs[0]);
    mexPrintf("mrows = %d\n", mrows);
    mexPrintf("mcols = %d\n", ncols);

//     plhs[0] = mxCreateDoubleMatrix((mwSize)mrows, (mwSize)ncols, mxREAL);
//     double v[mrows*ncols];
    double* v = (double*)mxMalloc(mrows*ncols*sizeof(double));
    for (int i = 0; i < mrows*ncols; ++i){
//         v[i] = i;
        v[i] = probeDefocusArray[i];
        mexPrintf("val %f\n",v[i]); 
    };
    plhs[0] = mxCreateNumericMatrix(0,0,mxDOUBLE_CLASS,mxREAL);

    mxSetPr(plhs[0], v); 
    mxSetM(plhs[0],mrows);
    mxSetN(plhs[0],ncols);
    
    
//     plhs[0] = mxGetPr(prhs[0]);
    
     
      //initialize:
   /*
    q1 = zeros(imageSizeReduce);
    q2 = zeros(imageSizeReduce);
    PsiProbeInit = zeros(imageSizeReduce);
    psi = zeros(imageSizeReduce);
    intOutput = zeros(imageSizeReduce);
     */
    //dq = mean([qxaReduce(2,1) qyaReduce(1,2)]);
    //qProbeMax = emdSTEM.probeSemiangleArray(a1) / emdSTEM.lambda;
}